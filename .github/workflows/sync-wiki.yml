# SPDX-License-Identifier: Apache-2.0
name: Sync Wiki to Docs

on:
  push:
    branches:
      - "**"          # Run on all branches
  pull_request:        # Ensure PR builds include wiki
  schedule:
    - cron: "0 6 * * *"  # Daily sync at 6 AM UTC
  workflow_dispatch:    # Manual trigger

permissions:
  contents: write  # Needed to create branches/commits
  pull-requests: write  # Needed to open PRs

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          path: main

      - name: Checkout wiki repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      - name: Sync wiki into docs/source/wiki
        run: |
          # Ensure no nested .git remains from previous runs
          if [ -d main/docs/source/wiki ]; then
            find main/docs/source/wiki -name .git -type d -prune -exec rm -rf {} + || true
          fi
          # Mirror wiki contents but exclude the wiki's .git directory
          rsync -av --delete --exclude '.git' wiki/ main/docs/source/wiki/

      - name: Create PR with synced wiki (DCO sign-off)
        uses: peter-evans/create-pull-request@v6
        with:
          path: main
          base: main
          branch: ci/sync-wiki
          delete-branch: true
          title: "chore(docs): sync wiki into docs/source/wiki"
          body: |
            Automated wiki sync from GitHub Wiki to docs/source/wiki.

            This commit includes a DCO Signed-off-by trailer to satisfy enforcement.
          commit-message: "chore(docs): sync wiki into docs/source/wiki"
          signoff: true
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
