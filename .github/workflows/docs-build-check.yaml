# SPDX-License-Identifier: Apache-2.0
name: Docs & Poster Build Check

on:
  pull_request:
    paths:
      - "docs/**"
      - "poster/**"
      - ".github/workflows/docs-build-check.yaml"
      - ".github/workflows/docs-pages.yaml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Sphinx and MyST
        run: |
          python -m pip install --upgrade pip
          pip install sphinx myst-parser sphinx_rtd_theme
          pip install -e .

      - name: Build Sphinx HTML
        working-directory: docs
        run: sphinx-build -b html source build

      - name: Build poster
        run: python poster/scripts/build_poster.py

      - name: Verify poster output
        run: |
          test -f poster/html/zyra-poster.html || { echo "ERROR: poster HTML not found"; exit 1; }
          echo "Poster size: $(du -h poster/html/zyra-poster.html | cut -f1)"
          echo "Image assets: $(find poster/html -name '*.png' | wc -l) files"

      - name: Detect LFS pointer files
        run: |
          POINTERS=$(find poster/html -name '*.png' -exec sh -c 'head -c 20 "$1" | grep -q "^version https://git-lfs" && echo "$1"' _ {} \;)
          if [ -n "$POINTERS" ]; then
            echo "ERROR: LFS pointers detected instead of real files:"
            echo "$POINTERS"
            exit 1
          fi
          echo "All PNG assets are real files (not LFS pointers)"

      - name: Assemble site (dry run)
        run: |
          mkdir -p docs/build/poster
          cp poster/html/zyra-poster.html docs/build/poster/
          cp poster/html/*.png docs/build/poster/
          echo "Site contents:"
          find docs/build -type f | head -30
          echo "Total size: $(du -sh docs/build | cut -f1)"
